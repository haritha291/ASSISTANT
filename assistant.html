<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Ask A&C ‚Äì Assistant</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
      const { useState } = React;

      // üîß CONFIG ‚Äî update these for your LangFlow instance
      const API_BASE = "http://127.0.0.1:7873/flow"; // e.g. your LangFlow server
      const FLOW_ID = "850d61c5-9fdb-4f6e-b24a-44bf6010cec9"; // from exported flow JSON
      const API_KEY = ""; // optional, if LangFlow requires auth

      function App() {
        const [messages, setMessages] = useState([]);
        const [input, setInput] = useState("");
        const [env, setEnv] = useState("");
        const [loading, setLoading] = useState(false);

        const DEFAULT_NAME = "Sai Haritha";
        const DEFAULT_CHANNEL = "Digital";
        const ENVS = ["DEV01","DEV02","DEV03","QA01","QA02","QA03","ITEA","ITET","PROD"];

        async function sendMessage() {
          if (!input.trim()) return;
          const userMsg = { role: "user", text: input };
          setMessages((m) => [...m, userMsg]);
          setInput("");
          setLoading(true);

          try {
            const payload = {
              input_value: input,
              user_input: input,
              environment: env || undefined,
              name: DEFAULT_NAME,
              support_channel: DEFAULT_CHANNEL,
              history: messages.map(m => `${m.role}: ${m.text}`).join("\n")
            };

            const res = await fetch(`${API_BASE}/v1/run/${FLOW_ID}?stream=false`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                ...(API_KEY ? { Authorization: `Bearer ${API_KEY}` } : {})
              },
              body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();
            const modelText =
              data?.outputs?.[0]?.outputs?.[0]?.messages?.[0]?.data?.text ||
              data?.text ||
              JSON.stringify(data, null, 2);

            setMessages((m) => [...m, { role: "assistant", text: modelText }]);
          } catch (err) {
            setMessages((m) => [...m, { role: "assistant", text: "‚ö†Ô∏è API Error: " + err.message }]);
          } finally {
            setLoading(false);
          }
        }

        return (
          <div className="max-w-3xl mx-auto p-6">
            <h1 className="text-xl font-bold mb-4">Ask A&C ‚Äì Support Assistant</h1>

            <div className="mb-4">
              <label className="text-sm text-slate-600">Environment:</label>
              <select
                value={env}
                onChange={(e) => setEnv(e.target.value)}
                className="ml-2 border rounded px-2 py-1"
              >
                <option value="">Select</option>
                {ENVS.map((e) => (
                  <option key={e} value={e}>{e}</option>
                ))}
              </select>
            </div>

            <div className="border rounded-lg bg-white h-96 p-3 overflow-y-auto mb-4">
              {messages.map((m, i) => (
                <div key={i} className={`mb-3 ${m.role === "user" ? "text-right" : "text-left"}`}>
                  <div
                    className={`inline-block px-3 py-2 rounded-lg ${
                      m.role === "user" ? "bg-slate-900 text-white" : "bg-slate-100 text-slate-800"
                    }`}
                  >
                    <pre className="whitespace-pre-wrap text-sm">{m.text}</pre>
                  </div>
                </div>
              ))}
              {loading && <div className="text-slate-500 text-sm">Nexa is thinking‚Ä¶</div>}
            </div>

            <div className="flex gap-2">
              <input
                className="flex-1 border rounded-lg px-3 py-2"
                placeholder="Type your message..."
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={(e) => e.key === "Enter" && sendMessage()}
              />
              <button
                onClick={sendMessage}
                className="bg-slate-900 text-white rounded-lg px-4 py-2"
                disabled={loading}
              >
                Send
              </button>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
